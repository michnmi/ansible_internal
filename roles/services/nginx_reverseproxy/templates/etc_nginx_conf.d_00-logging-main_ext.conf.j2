# Generated by Ansible â€” provides $req_id, extended access log, and enables it globally.

# Request id: prefer upstream-provided X-Request-ID, else fallback to connection+msec
map $http_x_request_id $req_id {
    default $http_x_request_id;
    ""      "$connection-$msec";
}

# Extended access log format
log_format main_ext
    '$remote_addr - $remote_user [$time_local] '
    '"$request" $status $body_bytes_sent '
    '"$http_referer" "$http_user_agent" "$http_x_forwarded_for" '
    'host="$host" server_name="$server_name" '
    'method=$request_method uri="$uri" args="$args" proto=$server_protocol '
    'req_len=$request_length bytes_sent=$bytes_sent '
    'rt=$request_time uconn=$upstream_connect_time uhead=$upstream_header_time urt=$upstream_response_time '
    'up_addr="$upstream_addr" up_status="$upstream_status" up_cache="$upstream_cache_status" '
    'req_id="$req_id" ssl="$ssl_protocol" ssl_cipher="$ssl_cipher" sni="$ssl_server_name" alpn="$ssl_alpn_protocol"';

# Enable it globally (placed here so the format is known at parse time)
access_log /var/log/nginx/access.log main_ext;
