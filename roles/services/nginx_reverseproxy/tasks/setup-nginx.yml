---
- name: 'Setup-nginx: Configure to allow for "sites-enabled" structure'
  ansible.builtin.lineinfile: # Perhaps blockinfile would be better here.
    path: "/etc/nginx/nginx.conf"
    insertafter: '.*include.*\*\.conf;'
    line: "    include /etc/nginx/sites-enabled/*;"

- name: "Setup-nginx: Allow for long FQDNs"
  ansible.builtin.lineinfile: # Perhaps blockinfile would be better here.
    path: "/etc/nginx/nginx.conf"
    insertbefore: '.*include.*\*\.conf;'
    line: "    server_names_hash_bucket_size  64;"

- name: "Setup-nginx: nginx logging: deploy 00-logging-main_ext.conf"
  ansible.builtin.template:
    src: "etc_nginx_conf.d_00-logging-main_ext.conf.j2"
    dest: "/etc/nginx/conf.d/00-logging-main_ext.conf"
    owner: "root"
    group: "root"
    mode: "0644"
  notify: "Reload Nginx"

- name: "Setup-nginx: nginx logging: remove access_log from nginx.conf (handled in conf.d)"
  ansible.builtin.lineinfile:
    path: /etc/nginx/nginx.conf
    regexp: '^\s*access_log\s+/var/log/nginx/access\.log\s+.*;'
    state: absent
  notify: "Reload Nginx"

- name: "Setup-nginx: Render host-allow map"
  ansible.builtin.template:
    src: "etc_nginx_conf.d_10-host-allow.map.conf.j2"
    dest: "/etc/nginx/conf.d/10-host-allow.map.conf"
    owner: "root"
    group: "root"
    mode: "0644"
  notify: "Reload Nginx"

- name: "Setup-nginx: Deploy antiscan maps"
  ansible.builtin.template:
    src: "etc_nginx_conf.d_20-antiscan.maps.conf.j2"
    dest: "/etc/nginx/conf.d/20-antiscan.maps.conf"
    owner: "root"
    group: "root"
    mode: "0644"
  notify: "Reload Nginx"

- name: "Setup-nginx: Deploy rate-limit zones"
  ansible.builtin.template:
    src: "etc_nginx_conf.d_30-ratelimit.conf.j2"
    dest: "/etc/nginx/conf.d/30-ratelimit.conf"
    owner: "root"
    group: "root"
    mode: "0644"
  notify: "Reload Nginx"

- name: "Setup-nginx: Create snippets directory"
  ansible.builtin.file:
    path: "/etc/nginx/snippets"
    owner: "root"
    group: "root"
    mode: "0755"
    state: directory

- name: "Nginx: deploy block-bots snippet"
  ansible.builtin.template:
    src: "etc_nginx_snippets_block-bots.conf.j2"
    dest: "/etc/nginx/snippets/block-bots.conf"
    owner: "root"
    group: "root"
    mode: "0644"
  notify: "Reload Nginx"

- name: 'Setup-nginx: Create "sites-enabled" structure'
  ansible.builtin.file:
    path: "/etc/nginx/{{ item }}"
    owner: "root"
    group: "root"
    mode: "0755"
    state: directory
  loop:
    - "sites-enabled"
    - "sites-available"

- name: "Setup-nginx: Create the reverseproxy configurations"
  ansible.builtin.template:
    src: "etc_nginx_sites-available_conf_reverseproxy_setup.j2"
    dest: "/etc/nginx/sites-available/{{ proxy.name }}"
    owner: "root"
    group: "root"
    mode: "0644"
  loop: "{{ reverseproxies }}"
  loop_control:
    loop_var: "proxy"
  notify: "Restart nginx"

- name: "Setup-nginx: Setup the links to sites-enabled"
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/{{ proxy.name }}"
    dest: "/etc/nginx/sites-enabled/{{ proxy.name }}"
    state: link
  loop: "{{ reverseproxies }}"
  loop_control:
    loop_var: "proxy"
  notify: "Restart nginx"

- name: "Setup-nginx: Create a basic index.html for port 80"
  ansible.builtin.copy:
    src: "files/var_www_index.html"
    dest: "{{ certbot_well_known }}/index.html"
    owner: "nginx"
    group: "nginx"
    mode: "0644"
  notify: "Restart nginx"

- name: "Setup-nginx: Create a default entry (port 80)"
  ansible.builtin.template:
    src: "etc_nginx_sites-available_default.j2"
    dest: "/etc/nginx/sites-available/default"
    owner: "root"
    group: "root"
    mode: "0644"
  notify: "Restart nginx"

- name: "Setup-nginx: Setup the link to sites-enabled for default"
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/default"
    dest: "/etc/nginx/sites-enabled/default"
    state: link
  notify: "Restart nginx"

- name: "Setup-nginx: Setup the certbot web root directory"
  ansible.builtin.file:
    path: "{{ certbot_well_known }}"
    owner: "{{ certbot_web_user }}"
    group: "{{ certbot_web_user }}"
    mode: "0755"
    state: "directory"

- name: "Setup-nginx: Start nginx before certbot renewal"
  ansible.builtin.service:
    name: "nginx"
    state: "started"
